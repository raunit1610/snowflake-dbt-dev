name: Execute DBT on Main Merge (Venv)

on:
  push:
    branches: ["main"]

permissions:
  contents: write   # needed because state file is updated

jobs:
# ==========================================================
# JOB 1: State-aware dbt run + generate target/manifest.json
# ==========================================================
  dbt-run:
    runs-on: ubuntu-latest

    env:
      DBT_TARGET: dev

      # Snowflake
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE_PROD }}
      SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
      SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Create Virtual Environment
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install dbt-core dbt-snowflake

      - name: Install dbt deps
        run: |
          source venv/bin/activate
          dbt deps --profiles-dir .

      # -----------------------------
      # Ensure state_path exists
      # -----------------------------
      - name: Prepare state folder
        run: mkdir -p state_path

      # -----------------------------
      # Validate state using dbt ls
      # -----------------------------
      - name: Validate state graph for modified state
        run: |
          source venv/bin/activate

          if [ -f "state_path/manifest.json" ]; then
            echo "‚ôªÔ∏è Existing state detected ‚Üí validating with dbt ls"
            dbt ls \
              --profiles-dir . \
              --state state_path \
              --select state:modified+
          else
            echo "üöÄ No previous state ‚Üí skipping state validation"
          fi
      
      - name: Validate state graph for new state
        run: |
          source venv/bin/activate

          if [ -f "state_path/manifest.json" ]; then
            echo "‚ôªÔ∏è Existing state detected ‚Üí validating with dbt ls"
            dbt ls \
              --profiles-dir . \
              --state state_path \
              --select state:new+
          else
            echo "üöÄ No previous state ‚Üí skipping state validation"
          fi

      # -----------------------------
      # dbt execution (creates target/manifest.json)
      # -----------------------------
      - name: Run dbt build for Modified state
        run: |
          source venv/bin/activate

          if [ -f "state_path/manifest.json" ]; then
            dbt build \
              --profiles-dir . \
              --state state_path \
              --select state:modified+
          else
            dbt build --profiles-dir .
          fi

      - name: Run dbt build for Modified state
        run: |
          source venv/bin/activate

          if [ -f "state_path/manifest.json" ]; then
            dbt build \
              --profiles-dir . \
              --state state_path \
              --select state:new+
          else
            dbt build --profiles-dir .
          fi

      # -----------------------------
      # Upload manifest for Job 2
      # -----------------------------
      - name: Upload new manifest
        uses: actions/upload-artifact@v4
        with:
          name: new-manifest
          path: target/manifest.json

# ==========================================================
# JOB 2: Update state_path/manifest.json
# ==========================================================
  update-state:
    needs: dbt-run
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download new manifest
        uses: actions/download-artifact@v4
        with:
          name: new-manifest
          path: target

      - name: Update state_path
        run: |
          mkdir -p state_path
          cp target/manifest.json state_path/manifest.json

      - name: Commit updated state
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add state_path/manifest.json
          git commit -m "Update dbt state manifest [CI]" || echo "No changes"
          git push
