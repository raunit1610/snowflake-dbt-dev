name: Execute DBT on Main Merge (Venv)

on:
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  execute-on-main:
    runs-on: ubuntu-latest

    env:
      DBT_TARGET: dev

      # Snowflake
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE_PROD }}
      SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
      SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}

      # AWS (STATIC KEYS)
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ap-south-1

      # S3
      DBT_ARTIFACT_BUCKET: ${{ secrets.DBT_ARTIFACT_BUCKET }}
      DBT_STATE_KEY: ${{ secrets.DBT_STATE_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # -----------------------------
      # Create virtual environment
      # -----------------------------
      - name: Create Virtual Environment
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip

      - name: Install dbt and boto3
        run: |
          source venv/bin/activate
          pip install dbt-core dbt-snowflake boto3

      - name: Install dbt dependencies
        run: |
          source venv/bin/activate
          dbt deps --profiles-dir .

      # -----------------------------
      # Download previous manifest from S3
      # -----------------------------
      - name: Download previous dbt manifest (if exists)
        run: |
          source venv/bin/activate
          mkdir -p prev_state

          python <<EOF
          import boto3, os
          from botocore.exceptions import ClientError

          s3 = boto3.client("s3", region_name=os.environ["AWS_REGION"])

          bucket = os.environ["DBT_ARTIFACT_BUCKET"]
          key = os.environ["DBT_STATE_KEY"]
          local_path = "prev_state/manifest.json"

          try:
              s3.download_file(bucket, key, local_path)
              print("âœ… Previous manifest downloaded from S3")
          except ClientError as e:
              if e.response["Error"]["Code"] == "404":
                  print("â„¹ï¸ No previous manifest found. First run.")
              else:
                  raise
          EOF

      # -----------------------------
      # dbt execution
      # -----------------------------
      - name: Run dbt with state awareness
        run: |
          source venv/bin/activate

          if [ ! -f "prev_state/manifest.json" ]; then
            echo "ðŸš€ FIRST RUN â†’ FULL dbt build"
            dbt build --profiles-dir .
          else
            echo "â™»ï¸ STATE-AWARE RUN"
            dbt build \
              --profiles-dir . \
              --state prev_state \
              --select state:modified+,state:new+
          fi

      # -----------------------------
      # Upload new manifest to S3
      # -----------------------------
      - name: Upload dbt manifest to S3
        if: success()
        run: |
          source venv/bin/activate

          python <<EOF
          import boto3, os

          s3 = boto3.client("s3", region_name=os.environ["AWS_REGION"])

          bucket = os.environ["DBT_ARTIFACT_BUCKET"]
          key = os.environ["DBT_STATE_KEY"]
          file_path = "target/manifest.json"

          s3.upload_file(file_path, bucket, key)
          print("âœ… New manifest uploaded to S3")
          EOF
