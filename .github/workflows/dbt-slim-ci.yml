# Challenge: Require Ephemeral Database
name: dbt-slim-ci

on:
  pull_request:
    branches: [main]

jobs:
  slim-ci:
    runs-on: ubuntu-latest

    env:
      DBT_TARGET: dev

      # Snowflake (CI / Ephemeral)
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE_CI }}
      SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
      SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}

    steps:
      # --------------------------------------------------
      # 1. Checkout PR branch
      # --------------------------------------------------
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          path: pr

      # --------------------------------------------------
      # 2. Python + virtual environment
      # --------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Create virtualenv
        run: |
          python -m venv .venv
          . .venv/bin/activate
          pip install --upgrade "pip<24"
          pip install "click==8.1.6"
          pip install "dbt-snowflake==1.9.1"

      # --------------------------------------------------
      # 3. Checkout main and create state manifest
      # --------------------------------------------------
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          path: main

      - name: Compile main to create state
        working-directory: main
        run: |
          . ../.venv/bin/activate
          dbt ls \
            --profiles-dir . \
            --target-path ../state_main

      # --------------------------------------------------
      # 4. Slim CI build (PR branch)
      # --------------------------------------------------
      - name: Slim CI build
        working-directory: pr
        run: |
          . ../.venv/bin/activate
          dbt build \
            --profiles-dir . \
            --state ../state_main \
            --select state:modified+,state:new+ \
            --defer --favor-state

      # --------------------------------------------------
      # 5. Install SnowSQL (for cleanup)
      # --------------------------------------------------
      - name: Install SnowSQL
        run: |
          curl -sS -O https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/snowsql-1.2.26-linux_x86_64.bash

          # SnowSQL installer may exit non-zero in CI â€” ignore it
          bash snowsql-1.2.26-linux_x86_64.bash || true

          # Locate snowsql binary
          find $HOME -name snowsql -type f

          # Add common install locations to PATH
          echo "$HOME/bin" >> $GITHUB_PATH
          echo "$HOME/.snowsql" >> $GITHUB_PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # --------------------------------------------------
      # 6. Cleanup: Drop ephemeral Snowflake database
      # --------------------------------------------------
      - name: Cleanup ephemeral Snowflake database
        if: always()
        env:
          SNOWSQL_PWD: ${{ secrets.SNOWFLAKE_PASSWORD }}
        run: |
          set -e

          which snowsql
          snowsql --version

          echo "ðŸ§¹ Dropping CI database: $SNOWFLAKE_DATABASE"

          snowsql \
            -a "$SNOWFLAKE_ACCOUNT" \
            -u "$SNOWFLAKE_USER" \
            -r "$SNOWFLAKE_ROLE" \
            -w "$SNOWFLAKE_WAREHOUSE" \
            -q "DROP DATABASE IF EXISTS ${SNOWFLAKE_DATABASE};"
