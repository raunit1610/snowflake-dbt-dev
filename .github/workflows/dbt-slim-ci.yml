name: dbt-slim-ci

on:
  pull_request:
    branches: [main]

jobs:
  slim-ci:
    runs-on: ubuntu-latest

    env:
      DBT_TARGET: dev
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE_CI }}
      SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
      SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}

    steps:
      # 0. Checkout PR code first (current ref)
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          path: pr

      # 1. Set up Python and venv at workspace root
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Create virtualenv
        run: |
          python -m venv .venv
          . .venv/bin/activate
          pip install --upgrade "pip<24"
          pip install click==8.1.6
          pip install dbt-snowflake==1.9.1

          # Persist PATH so venv python is available in later steps
          echo "$GITHUB_WORKSPACE/.venv/bin" >> $GITHUB_PATH

      # 2. Checkout main and compile to create state manifest
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          path: main

      - name: Compile main to state
        working-directory: main
        run: |
          . $GITHUB_WORKSPACE/.venv/bin/activate
          dbt compile --target-path ../state_main --profiles-dir .

      # 3. Run slim CI using state from main
      - name: Slim CI build
        working-directory: pr
        run: |
          . $GITHUB_WORKSPACE/.venv/bin/activate
          dbt build \
            --select "state:modified+1" \
            --state ../state_main \
            --defer --favor-state \
            --profiles-dir .

      #4. Install SnowSQL to DROP Database
      - name: Install SnowSQL
        run: |
          . $GITHUB_WORKSPACE/.venv/bin/activate

          # Correct download with fail flag
          curl -O --fail https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/snowsql

          chmod +x snowsql-1.2.25-linux_x86_64.bash

          SNOWSQL_ENV_ACCEPT_LICENSES=Y \
          SNOWSQL_RUN_LOGFILE=~/snowsql_run.log \
          bash snowsql-1.2.25-linux_x86_64.bash

          echo "$HOME/bin" >> $GITHUB_PATH


      #5. Drop Slim_CI Database after PR build
      - name: Run DROP DATABASE command
        env:
          SNOWSQL_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWSQL_PWD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWSQL_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          DB_NAME_TO_DROP: ${{ secrets.SNOWFLAKE_DATABASE_CI }}
        run: |
          . $GITHUB_WORKSPACE/.venv/bin/activate
          snowsql -q "DROP DATABASE IF EXISTS $DB_NAME_TO_DROP CASCADE;"
